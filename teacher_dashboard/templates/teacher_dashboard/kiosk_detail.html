{% extends 'teacher_dashboard/base.html' %}

{% block title %}{{ kiosk.name }} - キオスク詳細{% endblock title %}
{% block page_title %}{{ kiosk.name }} - キオスク詳細{% endblock page_title %}

{% block content %}
<!-- パンくずナビ -->
<nav style="margin-bottom: 20px;">
    <ol style="display: flex; list-style: none; padding: 0; margin: 0; font-size: 14px; color: var(--text-secondary);">
        <li><a href="{% url 'teacher_dashboard:dashboard_home' %}" style="color: var(--primary-color); text-decoration: none;">ダッシュボード</a></li>
        <li style="margin: 0 8px;">/</li>
        <li><a href="{% url 'teacher_dashboard:kiosk_management' %}" style="color: var(--primary-color); text-decoration: none;">キオスク管理</a></li>
        <li style="margin: 0 8px;">/</li>
        <li>{{ kiosk.name }}</li>
    </ol>
</nav>

<!-- キオスク基本情報 -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0 0 10px; font-size: 24px; color: var(--text-primary);">
                <i class="fas fa-desktop"></i>
                {{ kiosk.name }}
            </h2>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <span style="color: var(--text-secondary);">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ kiosk.location }}
                </span>
                <span class="badge {% if kiosk.is_active %}badge-success{% else %}badge-warning{% endif %}" style="font-size: 14px;">
                    {% if kiosk.is_active %}
                        <i class="fas fa-check-circle"></i>
                        アクティブ
                    {% else %}
                        <i class="fas fa-pause-circle"></i>
                        非アクティブ
                    {% endif %}
                </span>
                {% if kiosk.last_activity %}
                <span style="color: var(--text-secondary); font-size: 14px;">
                    <i class="fas fa-clock"></i>
                    最終活動: {{ kiosk.last_activity|date:"Y/m/d H:i" }}
                </span>
                {% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'teacher_dashboard:attendance_history' %}?kiosk={{ kiosk.id }}" class="btn btn-secondary">
                <i class="fas fa-history"></i>
                出席履歴
            </a>
            <a href="{% url 'teacher_dashboard:attendance_export' %}?kiosk={{ kiosk.id }}" class="btn btn-success">
                <i class="fas fa-download"></i>
                CSV出力
            </a>
        </div>
    </div>
</div>

<!-- 統計カード -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.today_attendance }}</div>
        <div class="stat-label">今日の出席者数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.week_attendance }}</div>
        <div class="stat-label">今週の出席者数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.active_tokens }}</div>
        <div class="stat-label">有効なトークン数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_attendance }}</div>
        <div class="stat-label">総出席者数</div>
    </div>
</div>

<!-- 今日の出席状況 -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 class="card-title" style="margin: 0;">
            <i class="fas fa-calendar-day"></i>
            今日の出席状況 ({{ today|date:"Y年m月d日" }})
        </h3>
        <button onclick="refreshAttendance()" class="btn btn-secondary" style="font-size: 12px;">
            <i class="fas fa-sync-alt"></i>
            更新
        </button>
    </div>
    
    {% if today_attendance %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>時刻</th>
                        <th>学生名</th>
                        <th>学生ID</th>
                        <th>ステータス</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in today_attendance %}
                    <tr>
                        <td>{{ record.attended_at|date:"H:i:s" }}</td>
                        <td>{{ record.user.name|default:record.user.username }}</td>
                        <td>{{ record.user.username }}</td>
                        <td>
                            <span class="badge badge-success">
                                <i class="fas fa-check"></i>
                                出席
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>今日はまだ出席記録がありません</p>
        </div>
    {% endif %}
</div>

<!-- 週間出席傾向 -->
<div class="card">
    <h3 class="card-title">
        <i class="fas fa-chart-line"></i>
        週間出席傾向
    </h3>
    <div class="week-chart" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px;">
        {% for day_data in week_data %}
        <div style="text-align: center;">
            <div style="background-color: var(--background-color); border-radius: 6px; padding: 15px; margin-bottom: 8px;">
                <div style="font-size: 20px; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;">{{ day_data.count }}</div>
                <div style="height: {{ day_data.height }}px; background-color: var(--primary-color); border-radius: 2px; margin: 0 auto; width: 20px;"></div>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">{{ day_data.day_name }}</div>
            <div style="font-size: 10px; color: var(--text-secondary);">{{ day_data.date|date:"m/d" }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 有効なトークン一覧 -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 class="card-title" style="margin: 0;">
            <i class="fas fa-key"></i>
            有効なトークン一覧
        </h3>
        <span style="color: var(--text-secondary); font-size: 14px;">{{ active_tokens|length }}個のトークン</span>
    </div>
    
    {% if active_tokens %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>トークン</th>
                        <th>作成日時</th>
                        <th>有効期限</th>
                        <th>使用状況</th>
                        <th>残り時間</th>
                    </tr>
                </thead>
                <tbody>
                    {% for token in active_tokens %}
                    <tr>
                        <td>
                            <code style="background-color: var(--background-color); padding: 4px 8px; border-radius: 4px; font-family: monospace;">{{ token.token }}</code>
                        </td>
                        <td>{{ token.created_at|date:"m/d H:i" }}</td>
                        <td>{{ token.expires_at|date:"m/d H:i" }}</td>
                        <td>
                            {% if token.is_used %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check"></i>
                                    使用済み
                                </span>
                            {% else %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-clock"></i>
                                    未使用
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="time-remaining" data-expires="{{ token.expires_at|date:'c' }}">
                                計算中...
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fas fa-key" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>有効なトークンがありません</p>
        </div>
    {% endif %}
</div>

<!-- 最近の活動ログ -->
<div class="card">
    <h3 class="card-title">
        <i class="fas fa-list-alt"></i>
        最近の活動ログ
    </h3>
    
    {% if recent_activities %}
        <div class="activity-timeline">
            {% for activity in recent_activities %}
            <div style="display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color);">
                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                    <i class="fas fa-user" style="color: white; font-size: 16px;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: var(--text-primary);">{{ activity.user.name|default:activity.user.username }}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">出席記録が作成されました</div>
                </div>
                <div style="text-align: right; color: var(--text-secondary); font-size: 14px;">
                    <div>{{ activity.attended_at|date:"H:i" }}</div>
                    <div style="font-size: 12px;">{{ activity.attended_at|date:"m/d" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'teacher_dashboard:attendance_history' %}?kiosk={{ kiosk.id }}" class="btn btn-secondary">
                <i class="fas fa-list"></i>
                すべての履歴を見る
            </a>
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fas fa-list-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>最近の活動がありません</p>
        </div>
    {% endif %}
</div>
{% endblock content %}

{% block extra_css %}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    
    .week-chart {
        min-height: 120px;
    }
    
    .activity-timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .week-chart {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .card > div:first-child {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .week-chart {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
    // 残り時間の計算と表示
    function updateTimeRemaining() {
        const elements = document.querySelectorAll('.time-remaining');
        elements.forEach(element => {
            const expiresAt = new Date(element.dataset.expires);
            const now = new Date();
            const diff = expiresAt - now;
            
            if (diff <= 0) {
                element.textContent = '期限切れ';
                element.style.color = 'var(--text-secondary)';
            } else {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                element.textContent = `${hours}時間${minutes}分`;
                element.style.color = hours < 1 ? '#dc2626' : 'var(--text-primary)';
            }
        });
    }
    
    // 初回実行と1分ごとの更新
    updateTimeRemaining();
    setInterval(updateTimeRemaining, 60000);
    
    // 出席状況の更新
    function refreshAttendance() {
        location.reload();
    }
    
    // 自動更新（5分ごと）
    setInterval(function() {
        if (!document.hidden) {
            location.reload();
        }
    }, 300000); // 5分 = 300000ms
</script>
{% endblock extra_js %}