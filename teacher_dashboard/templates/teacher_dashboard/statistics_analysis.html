{% extends 'teacher_dashboard/base.html' %}

{% block title %}統計・分析{% endblock title %}
{% block page_title %}統計・分析{% endblock page_title %}

{% block content %}
<!-- 期間選択 -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="margin: 0;">
            <i class="fas fa-chart-bar"></i>
            統計・分析
        </h2>
        <button onclick="refreshData()" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i>
            データ更新
        </button>
    </div>
    
    <!-- 期間選択フォーム -->
    <form method="get" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
        <div>
            <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;">開始日</label>
            <input type="date" name="date_from" value="{{ request.GET.date_from|default:default_date_from }}" 
                   style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;">終了日</label>
            <input type="date" name="date_to" value="{{ request.GET.date_to|default:default_date_to }}" 
                   style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;">キオスク</label>
            <select name="kiosk" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; min-width: 150px;">
                <option value="">すべてのキオスク</option>
                {% for kiosk in kiosks %}
                <option value="{{ kiosk.id }}" {% if request.GET.kiosk == kiosk.id|stringformat:"s" %}selected{% endif %}>
                    {{ kiosk.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i>
            分析実行
        </button>
        <button type="button" onclick="setPresetPeriod('week')" class="btn btn-secondary">今週</button>
        <button type="button" onclick="setPresetPeriod('month')" class="btn btn-secondary">今月</button>
    </form>
</div>

<!-- 統計サマリー -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_attendance }}</div>
        <div class="stat-label">総出席数</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
            {% if stats.attendance_change >= 0 %}
                <i class="fas fa-arrow-up" style="color: var(--accent-color);"></i>
                前期間比 +{{ stats.attendance_change }}%
            {% else %}
                <i class="fas fa-arrow-down" style="color: #dc2626;"></i>
                前期間比 {{ stats.attendance_change }}%
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.unique_students }}</div>
        <div class="stat-label">出席学生数</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
            全学生の{{ stats.student_participation_rate|floatformat:1 }}%
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.avg_daily_attendance|floatformat:1 }}</div>
        <div class="stat-label">1日平均出席数</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
            最大: {{ stats.max_daily_attendance }}人
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.peak_hour }}</div>
        <div class="stat-label">ピーク時間帯</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
            {{ stats.peak_hour_count }}件の出席
        </div>
    </div>
</div>

<!-- 日別出席グラフ -->
<div class="card">
    <h3 class="card-title">
        <i class="fas fa-chart-line"></i>
        日別出席推移
    </h3>
    <div class="chart-container">
        <canvas id="dailyAttendanceChart" style="max-height: 400px;"></canvas>
    </div>
</div>

<!-- 時間帯別・キオスク別分析 -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- 時間帯別出席 -->
    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-clock"></i>
            時間帯別出席
        </h3>
        <div class="chart-container">
            <canvas id="hourlyAttendanceChart" style="max-height: 300px;"></canvas>
        </div>
    </div>
    
    <!-- キオスク別出席 -->
    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-desktop"></i>
            キオスク別出席
        </h3>
        <div class="chart-container">
            <canvas id="kioskAttendanceChart" style="max-height: 300px;"></canvas>
        </div>
    </div>
</div>

<!-- 曜日別・学生別分析 -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- 曜日別出席 -->
    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-calendar-week"></i>
            曜日別出席パターン
        </h3>
        <div class="weekday-chart">
            {% for day in weekday_stats %}
            <div class="weekday-item">
                <div class="weekday-name">{{ day.name }}</div>
                <div class="weekday-bar">
                    <div class="weekday-fill" style="width: {{ day.percentage }}%; background-color: var(--primary-color);"></div>
                </div>
                <div class="weekday-count">{{ day.count }}件</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 上位出席学生 -->
    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-trophy"></i>
            出席上位学生
        </h3>
        <div class="top-students">
            {% for user in top_students %}
                <div class="student-item">
                    <div class="student-rank">{{ forloop.counter }}</div>
                    <div class="student-info">
                        <div class="student-name">{{ user.name|default:user.username }}</div>
                        <div class="student-id">{{ user.username }}</div>
                    </div>
                    <div class="student-count">{{ user.attendance_count }}回</div>
                </div>
                {% endfor %}
        </div>
    </div>
</div>

<!-- 詳細データテーブル -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 class="card-title" style="margin: 0;">
            <i class="fas fa-table"></i>
            詳細データ
        </h3>
        <a href="{% url 'teacher_dashboard:attendance_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success">
            <i class="fas fa-download"></i>
            詳細データをエクスポート
        </a>
    </div>
    
    <!-- キオスク別詳細統計 -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>キオスク</th>
                    <th>場所</th>
                    <th>出席数</th>
                    <th>利用学生数</th>
                    <th>平均利用時間</th>
                    <th>最終利用</th>
                </tr>
            </thead>
            <tbody>
                {% for kiosk_stat in kiosk_stats %}
                <tr>
                    <td>
                        <a href="{% url 'teacher_dashboard:kiosk_detail' kiosk_stat.kiosk.id %}" 
                           style="color: var(--primary-color); text-decoration: none;">
                            {{ kiosk_stat.kiosk.name }}
                        </a>
                    </td>
                    <td>{{ kiosk_stat.kiosk.location }}</td>
                    <td>
                        <span style="font-weight: bold;">{{ kiosk_stat.attendance_count }}</span>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ({{ kiosk_stat.percentage|floatformat:1 }}%)
                        </div>
                    </td>
                    <td>{{ kiosk_stat.unique_students }}</td>
                    <td>{{ kiosk_stat.avg_session_time|default:"--" }}</td>
                    <td>
                        {% if kiosk_stat.last_attendance %}
                            {{ kiosk_stat.last_attendance|date:"m/d H:i" }}
                        {% else %}
                            <span style="color: var(--text-secondary);">なし</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 分析レポート（将来の拡張用） -->
{% comment %}
<div class="card">
    <h3 class="card-title">
        <i class="fas fa-file-alt"></i>
        分析レポート
    </h3>
    <div class="report-content">
        <div class="report-section">
            <h4>出席傾向の分析</h4>
            <p>{{ analysis_report.attendance_trend }}</p>
        </div>
        <div class="report-section">
            <h4>推奨事項</h4>
            <ul>
                {% for recommendation in analysis_report.recommendations %}
                <li>{{ recommendation }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endcomment %}
{% endblock content %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        margin-top: 20px;
    }
    
    .weekday-chart {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    
    .weekday-item {
        display: grid;
        grid-template-columns: 60px 1fr 60px;
        align-items: center;
        gap: 15px;
    }
    
    .weekday-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .weekday-bar {
        height: 20px;
        background-color: var(--background-color);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .weekday-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .weekday-count {
        font-size: 14px;
        font-weight: bold;
        color: var(--text-primary);
        text-align: right;
    }
    
    .top-students {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
    }
    
    .student-item {
        display: grid;
        grid-template-columns: 40px 1fr 60px;
        align-items: center;
        gap: 15px;
        padding: 12px;
        background-color: var(--background-color);
        border-radius: 6px;
    }
    
    .student-rank {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
    
    .student-rank:nth-child(1) {
        background-color: #ffd700;
        color: #000;
    }
    
    .student-item:nth-child(1) .student-rank {
        background-color: #ffd700;
        color: #000;
    }
    
    .student-item:nth-child(2) .student-rank {
        background-color: #c0c0c0;
        color: #000;
    }
    
    .student-item:nth-child(3) .student-rank {
        background-color: #cd7f32;
        color: #fff;
    }
    
    .student-info {
        display: flex;
        flex-direction: column;
    }
    
    .student-name {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .student-id {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .student-count {
        font-weight: bold;
        color: var(--primary-color);
        text-align: right;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        div[style*="grid-template-columns: 1fr 1fr"] {
            grid-template-columns: 1fr;
        }
        
        .weekday-item {
            grid-template-columns: 50px 1fr 50px;
            gap: 10px;
        }
        
        .student-item {
            grid-template-columns: 35px 1fr 50px;
            gap: 10px;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // グラフの色設定
    const colors = {
        primary: 'rgb(37, 99, 235)',
        secondary: 'rgb(100, 116, 139)',
        accent: 'rgb(16, 185, 129)',
        background: 'rgba(37, 99, 235, 0.1)'
    };
    
    // 日別出席グラフ
    const dailyCtx = document.getElementById('dailyAttendanceChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: {{ daily_labels|safe }},
            datasets: [{
                label: '出席数',
                data: {{ daily_data|safe }},
                borderColor: colors.primary,
                backgroundColor: colors.background,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // 時間帯別出席グラフ
    const hourlyCtx = document.getElementById('hourlyAttendanceChart').getContext('2d');
    new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: {{ hourly_labels|safe }},
            datasets: [{
                label: '出席数',
                data: {{ hourly_data|safe }},
                backgroundColor: colors.primary,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // キオスク別出席グラフ
    const kioskCtx = document.getElementById('kioskAttendanceChart').getContext('2d');
    new Chart(kioskCtx, {
        type: 'doughnut',
        data: {
            labels: {{ kiosk_labels|safe }},
            datasets: [{
                data: {{ kiosk_data|safe }},
                backgroundColor: [
                    colors.primary,
                    colors.accent,
                    colors.secondary,
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 期間プリセット設定
    function setPresetPeriod(period) {
        const today = new Date();
        let startDate, endDate;
        
        if (period === 'week') {
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            startDate = monday;
            endDate = today;
        } else if (period === 'month') {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = today;
        }
        
        document.querySelector('input[name="date_from"]').value = startDate.toISOString().split('T')[0];
        document.querySelector('input[name="date_to"]').value = endDate.toISOString().split('T')[0];
    }
    
    // データ更新
    function refreshData() {
        location.reload();
    }
    
    // 自動更新（15分ごと）
    setInterval(function() {
        if (!document.hidden) {
            location.reload();
        }
    }, 900000); // 15分 = 900000ms
</script>
{% endblock extra_js %}