{% extends 'teacher_dashboard/base.html' %}

{% block title %}出席履歴{% endblock title %}
{% block page_title %}出席履歴{% endblock page_title %}

{% block content %}
<!-- フィルター・検索バー -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="card-title" style="margin: 0;">
            <i class="fas fa-history"></i>
            出席履歴
        </h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span style="color: var(--text-secondary); font-size: 14px;">合計: {{ total_records }}件</span>
            <a href="{% url 'teacher_dashboard:attendance_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success">
                <i class="fas fa-download"></i>
                CSV出力
            </a>
        </div>
    </div>
    
    <!-- 検索・フィルターフォーム -->
    <form method="get" class="filter-form">
        <div class="filter-row">
            <!-- 検索キーワード -->
            <div class="filter-group">
                <label>学生名・ID検索</label>
                <input type="text" name="search" value="{{ request.GET.search }}" 
                       placeholder="学生名またはIDで検索" 
                       class="form-input">
            </div>
            
            <!-- キオスク選択 -->
            <div class="filter-group">
                <label>キオスク</label>
                <select name="kiosk" class="form-select">
                    <option value="">すべてのキオスク</option>
                    {% for kiosk in kiosks %}
                    <option value="{{ kiosk.id }}" {% if request.GET.kiosk == kiosk.id|stringformat:"s" %}selected{% endif %}>
                        {{ kiosk.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- 日付範囲 -->
            <div class="filter-group">
                <label>開始日</label>
                <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-input">
            </div>
            
            <div class="filter-group">
                <label>終了日</label>
                <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-input">
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                検索
            </button>
            {% if request.GET.search or request.GET.kiosk or request.GET.date_from or request.GET.date_to %}
            <a href="{% url 'teacher_dashboard:attendance_history' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                クリア
            </a>
            {% endif %}
            <button type="button" onclick="setTodayFilter()" class="btn btn-secondary">
                <i class="fas fa-calendar-day"></i>
                今日
            </button>
            <button type="button" onclick="setWeekFilter()" class="btn btn-secondary">
                <i class="fas fa-calendar-week"></i>
                今週
            </button>
        </div>
    </form>
</div>

<!-- 統計サマリー -->
{% if attendance_records %}
<div class="stats-grid" style="margin-bottom: 20px;">
    <div class="stat-card">
        <div class="stat-number">{{ total_records }}</div>
        <div class="stat-label">総出席記録数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ unique_students }}</div>
        <div class="stat-label">出席学生数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ unique_kiosks }}</div>
        <div class="stat-label">使用キオスク数</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ date_range }}</div>
        <div class="stat-label">期間（日）</div>
    </div>
</div>
{% endif %}

<!-- 出席記録一覧 -->
{% if attendance_records %}
    <div class="card">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <a href="?{{ request.GET.urlencode }}&sort=timestamp{% if request.GET.sort == 'timestamp' %}&order=desc{% endif %}" 
                               style="color: inherit; text-decoration: none;">
                                日時
                                {% if request.GET.sort == 'timestamp' %}
                                    {% if request.GET.order == 'desc' %}
                                        <i class="fas fa-sort-down"></i>
                                    {% else %}
                                        <i class="fas fa-sort-up"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?{{ request.GET.urlencode }}&sort=student{% if request.GET.sort == 'student' %}&order=desc{% endif %}" 
                               style="color: inherit; text-decoration: none;">
                                学生名
                                {% if request.GET.sort == 'student' %}
                                    {% if request.GET.order == 'desc' %}
                                        <i class="fas fa-sort-down"></i>
                                    {% else %}
                                        <i class="fas fa-sort-up"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>学生ID</th>
                        <th>
                            <a href="?{{ request.GET.urlencode }}&sort=kiosk{% if request.GET.sort == 'kiosk' %}&order=desc{% endif %}" 
                               style="color: inherit; text-decoration: none;">
                                キオスク
                                {% if request.GET.sort == 'kiosk' %}
                                    {% if request.GET.order == 'desc' %}
                                        <i class="fas fa-sort-down"></i>
                                    {% else %}
                                        <i class="fas fa-sort-up"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-sort"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>場所</th>
                        <th>ステータス</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_records %}
                    <tr class="attendance-row" data-record-id="{{ record.id }}">
                        <td>
                            <div style="font-weight: 500;">{{ record.timestamp|date:"Y/m/d" }}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">{{ record.timestamp|date:"H:i:s" }}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ record.user.name|default:record.user.username }}</div>
                        {% if record.user.name and record.user.name != record.user.username %}
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ record.user.username }}</div>
                        {% endif %}
                        </td>
                        <td>
                            <code style="background-color: var(--background-color); padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                {{ record.user.username }}
                            </code>
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ record.kiosk.name }}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ record.kiosk.location }}</div>
                        </td>
                        <td>
                            <span style="font-size: 12px; color: var(--text-secondary);">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ record.kiosk.location }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-success">
                                <i class="fas fa-check"></i>
                                出席
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ページネーション（将来の拡張用） -->
        {% comment %}
        {% if is_paginated %}
        <div class="pagination-container">
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?{{ request.GET.urlencode }}&page=1" class="btn btn-secondary">最初</a>
                    <a href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}" class="btn btn-secondary">前へ</a>
                {% endif %}
                
                <span class="page-info">
                    ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                    ({{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ page_obj.paginator.count }}件)
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}" class="btn btn-secondary">次へ</a>
                    <a href="?{{ request.GET.urlencode }}&page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary">最後</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endcomment %}
    </div>
{% else %}
    <div class="card">
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 64px; margin-bottom: 20px;"></i>
            <h3 style="margin: 0 0 10px; color: var(--text-primary);">出席記録が見つかりません</h3>
            {% if request.GET.search or request.GET.kiosk or request.GET.date_from or request.GET.date_to %}
                <p>検索条件に一致する出席記録がありません。</p>
                <div style="margin-top: 20px;">
                    <a href="{% url 'teacher_dashboard:attendance_history' %}" class="btn btn-primary">
                        <i class="fas fa-refresh"></i>
                        すべての記録を表示
                    </a>
                </div>
            {% else %}
                <p>出席記録がまだありません。</p>
                <p style="font-size: 14px;">学生がキオスクで出席登録を行うと、ここに記録が表示されます。</p>
            {% endif %}
        </div>
    </div>
{% endif %}

<!-- 出席傾向グラフ（将来の拡張用） -->
{% comment %}
{% if attendance_records %}
<div class="card" style="margin-top: 20px;">
    <h3 class="card-title">
        <i class="fas fa-chart-line"></i>
        出席傾向
    </h3>
    <div id="attendanceChart" style="height: 300px;"></div>
</div>
{% endif %}
{% endcomment %}
{% endblock content %}

{% block extra_css %}
<style>
    .filter-form {
        background-color: var(--background-color);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .form-input, .form-select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
    }
    
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .attendance-row:hover {
        background-color: var(--background-color);
    }
    
    .pagination-container {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .page-info {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0 15px;
    }
    
    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }
        
        .filter-actions {
            flex-direction: column;
        }
        
        .filter-actions .btn {
            width: 100%;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .table {
            font-size: 14px;
        }
        
        .table th, .table td {
            padding: 8px;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
    // 今日の日付フィルター設定
    function setTodayFilter() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="date_from"]').value = today;
        document.querySelector('input[name="date_to"]').value = today;
    }
    
    // 今週の日付フィルター設定
    function setWeekFilter() {
        const today = new Date();
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        document.querySelector('input[name="date_from"]').value = monday.toISOString().split('T')[0];
        document.querySelector('input[name="date_to"]').value = sunday.toISOString().split('T')[0];
    }
    
    // フォームのエンターキー対応
    document.querySelectorAll('.form-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.closest('form').submit();
            }
        });
    });
    
    // 行クリックでハイライト
    document.querySelectorAll('.attendance-row').forEach(row => {
        row.addEventListener('click', function() {
            // 既存のハイライトを削除
            document.querySelectorAll('.attendance-row').forEach(r => {
                r.style.backgroundColor = '';
            });
            // 新しいハイライトを追加
            this.style.backgroundColor = 'var(--background-color)';
        });
    });
    
    // 自動更新（10分ごと）
    setInterval(function() {
        if (!document.hidden) {
            location.reload();
        }
    }, 600000); // 10分 = 600000ms
</script>
{% endblock extra_js %}