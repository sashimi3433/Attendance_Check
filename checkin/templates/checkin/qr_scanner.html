{% extends "form-base.html" %}
{% load static %}

{% block title %}QRコード読み取り - キオスク端末{% endblock title %}

{% block excss %}
<link rel="stylesheet" href="{% static 'css/qr_scanner.css' %}">
{% endblock excss %}
{% block exjs %}

<!-- QRコードリーダーライブラリ -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
let html5QrcodeScanner;

// ページ読み込み時にQRコードスキャナーを初期化
document.addEventListener('DOMContentLoaded', function() {
    initQRScanner();
    initEventListeners();
    startRealTimeClock();
});

// イベントリスナーの初期化
function initEventListeners() {
    // メッセージを閉じるボタンの存在確認
    const closeMessageBtn = document.getElementById('close-message-btn');
    if (closeMessageBtn) {
        closeMessageBtn.addEventListener('click', function() {
            resetScanner();
        });
    } else {
        console.warn('close-message-btnが見つかりません');
    }
}

// リアルタイム時計を開始
function startRealTimeClock() {
    updateClock();
    setInterval(updateClock, 1000);
}

// 時計を更新
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleString('ja-JP');
    // 時計を表示する要素がないので、必要に応じて追加
}

// スキャナーをリセット
function resetScanner() {
    const messageContainer = document.getElementById('message-container');
    const qrReader = document.getElementById('qr-reader');
    
    if (messageContainer) {
        messageContainer.style.display = 'none';
    }
    
    if (qrReader) {
        qrReader.style.display = 'block';
    }
    
    initQRScanner();
}

// QRコードスキャナーの初期化
function initQRScanner() {
    // DOM要素の存在確認
    const qrReaderElement = document.getElementById('qr-reader');
    if (!qrReaderElement) {
        console.error('QRリーダー要素が見つかりません');
        return;
    }

    try {
        // 既存のスキャナーがある場合はクリア
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(err => {
                console.warn('スキャナーのクリアに失敗:', err);
            });
        }

        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader",
            { 
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            false
        );
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    } catch (error) {
        console.error('QRスキャナーの初期化に失敗:', error);
        // エラーメッセージを表示
        showMessage('error', 'QRスキャナーの初期化に失敗しました');
    }
}

// QRコード読み取り成功時の処理
function onScanSuccess(decodedText, decodedResult) {
    console.log(`QRコード読み取り成功: ${decodedText}`);

    // QRスキャナーを停止
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }

    // 読み取り時間を取得
    const scanTime = new Date();

    // 時間帯に基づいて出席状態を判定
    const status = determineAttendanceStatus(scanTime);

    // 即座にチェックイン処理を実行
    processToken(decodedText, status);
}

// 時間帯に基づいて出席状態を判定
function determineAttendanceStatus(scanTime) {
    const minute = scanTime.getMinutes();
    // 毎時20分から30分の間は出席、それ以外は遅刻
    if (minute >= 20 && minute <= 30) {
        return 'present';
    } else {
        return 'late';
    }
}

// QRコード読み取り失敗時の処理
function onScanFailure(error) {
    // エラーログは出力しない（連続的に発生するため）
}



// トークンの処理
function processToken(token, status) {
    fetch('/checkin/confirm-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            token: token,
            status: status,
            location: '{{ user.name|default:user.username }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            // 遅刻の場合はlateタイプ、それ以外はsuccess
            const messageType = status === 'late' ? 'late' : 'success';
            showMessage(messageType, data.message);
        } else {
            // エラー時は通知を表示
            showMessage('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // エラー時は通知を表示
        showMessage('error', 'ネットワークエラーが発生しました');
    });
}

// メッセージを表示
function showMessage(type, message) {
    const messageContainer = document.getElementById('message-container');
    const messageText = document.getElementById('message-text');
    const messageIcon = document.getElementById('message-icon');
    const qrReader = document.getElementById('qr-reader');

    // DOM要素の存在確認
    if (!messageContainer || !messageText || !messageIcon) {
        console.error('メッセージ表示に必要な要素が見つかりません');
        return;
    }

    messageContainer.className = `message-container ${type}`;
    messageText.textContent = message;

    if (type === 'success') {
        messageIcon.textContent = '✓';
    } else if (type === 'late') {
        messageIcon.textContent = '⚠';
    } else {
        messageIcon.textContent = '✗';
    }

    if (qrReader) {
        qrReader.style.display = 'none';
    }
    messageContainer.style.display = 'block';

    // 3秒後に自動でスキャナーを再開
    setTimeout(() => {
        resetScanner();
    }, 3000);
}



// CSRFトークンの取得
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ログアウト処理
function logout() {
    console.log('ログアウト処理を開始します');
    try {
        // QRスキャナーを停止
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }
        
        // POSTリクエストでログアウトを実行
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/accounts/logout/';
        
        // CSRFトークンを追加
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        form.appendChild(csrfInput);
        
        // フォームをDOMに追加して送信
        document.body.appendChild(form);
        form.submit();
    } catch (error) {
        console.error('ログアウト処理中にエラーが発生しました:', error);
        // エラーが発生した場合はGETリクエストでフォールバック
        window.location.href = '/accounts/logout/';
    }
}
</script>
{% endblock exjs %}
{% block mainclass %}qr_scanner{% endblock mainclass %}
{% block content %}
<h2>チェックイン</h2>
    <div class="card">
        <div class="box">
        <p>現在受付中の授業: {% if current_lesson %}{{ current_lesson.subject }} (第{{ current_lesson.lesson_times }}回){% else %}受付中の授業なし{% endif %}</p>

        </div>

        <div id="qr-reader"></div>

        <!-- メッセージ表示コンテナ（初期は非表示） -->
        <div id="message-container" class="message-container" style="display: none;">
            <div class="message-content">
                <span id="message-icon" class="message-icon"></span>
                <span id="message-text" class="message-text"></span>
            </div>
            <button id="close-message-btn" class="txtbtn">閉じる</button>
        </div>

        <button class="txtbtn" onclick="logout()">ログアウト</button>
    </div>
</div>
{% endblock content %}